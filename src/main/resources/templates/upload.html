<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ - DC: –ì–û–°–¢ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="site-header">
    <div class="container">
        <div class="logo">DC<span>.GOST</span></div>
        <nav class="main-nav">
            <ul>
                <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="/upload">–ü—Ä–æ–≤–µ—Ä–∫–∞</a></li>
                <li id="loginButton">
                    <a href="#" onclick="openLoginModal(event)">–í–æ–π—Ç–∏</a>
                </li>
                
                <li id="userButton" style="display: none;">
                    <a href="#" onclick="logout(event)" id="logout-btn">
                        –í—ã–π—Ç–∏
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</header>

    <main>
        <section class="upload-section" id="upload">
            <div class="container">
                <h2 class="section-title">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 15 –ú–ë.</p>
                <form class="upload-form" method="post" enctype="multipart/form-data" th:action="@{/upload}">
                    <div class="file-upload-container">
                        <input type="file" id="custom-file-input" name="file" accept=".docx, .pdf, .txt" th:value="${file}" required>
                        <label for="custom-file-input">–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</label>
                    </div>
                
                    <div class="settings-container">
                        <div class="slider-group">
                            <label for="fontSize">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞: 
                                <span id="fontSizeValue" th:text="${#numbers.formatDecimal(fontSizeValue, 1, 0)} + ' pt'">14 pt</span>
                            </label>
                            <input type="range" id="fontSize" name="fontSize" min="1" max="16" step="1" 
                                   th:value="${fontSizeValue}">
                        </div>
                    
                        <div class="slider-group">
                            <label for="indent">–û—Ç—Å—Ç—É–ø: 
                                <span id="indentValue" th:text="${#numbers.formatDecimal(indentValue, 1, 2)} + ' —Å–º'">1.25 —Å–º</span>
                            </label>
                            <input type="range" id="indent" name="indent" min="1.0" max="1.5" step="0.05"
                                   th:value="${indentValue}">
                        </div>
                    
                        <div class="slider-group">
                            <label for="lineSpacing">–ú–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: 
                                <span id="lineSpacingValue" th:text="${#numbers.formatDecimal(lineSpacingValue, 1, 2)}">1.50</span>
                            </label>
                            <input type="range" id="lineSpacing" name="lineSpacing" min="1.0" max="2.0" step="0.25"
                                   th:value="${lineSpacingValue}">
                        </div>
                    </div>
                    <div class="form-buttons-container">
    
                        <button type="submit" class="cta-button">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</button>
                    
                        <a th:if="${html != null}" th:href="@{/download-styled(fontSize=${fontSizeValue})}" class="secondary-button">
                            –°–∫–∞—á–∞—Ç—å —Å –ì–û–°–¢
                        </a>
                        
                        
                    </div>
                </form>
            </div>
        </section>

        <div th:if="${html}">
            <div class="hint">
                üí° –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ <span style="background-color: #FFF8AD;">–∂—ë–ª—Ç—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É</span>, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± –æ—à–∏–±–∫–µ.
            </div>

            <section class="document-viewer">
                <div class="a4-page" th:utext="${html}"></div>
            </section>
        </div>
        <!-- <div style="display: none;", id="historyList">
        <section class="history-section">
            <div class="container">
                <h2 class="section-title">–ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫</h2>
                <table>
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞</th>
                            <th>–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item : ${historyItems}">
                            <td th:text="${item.documentName}">MyDocument.docx</td>
                            <td th:text="${#temporals.format(item.dateTime, 'dd.MM.yyyy HH:mm')}">18.07.2025 12:00</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div> -->

    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-column about">
                    <h3 class="logo">DC<span>.GOST</span></h3>
                    <p>
                        –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –ì–û–°–¢.
                    </p>
                </div>

                <div class="footer-column">
                    <h4>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h4>
                    <ul>
                        <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                        <li><a href="#upload">–ü—Ä–æ–≤–µ—Ä–∫–∞</a></li>
                        <li><a href="#">–†–µ—Å—É—Ä—Å—ã</a></li>
                        <li><a href="#">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h4>–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏</h4>
                    <ul>
                        <li><a href="mailto:info@dcgost.example">info@dcgost.example</a></li>
                        <li><a href="#">Telegram</a></li>
                        <li><a href="#">VKontakte</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 DC.GOST. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
            </div>
        </div>
    </footer>
    <div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeLoginModal()">&times;</span>
        <h2>–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h2>
        <p class="error-message" id="loginError"></p>
        <div class="form-group">
            <label for="login-username">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text" id="login-username" required>
        </div>
        <div class="form-group">
            <label for="login-password">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="login-password" required>
        </div>
        <button class="modal-button" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        <p class="modal-switch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="switchToRegisterModal(event)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></p>
    </div>
</div>

<div id="registerModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeRegisterModal()">&times;</span>
        <h2>–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h2>
        <p class="error-message" id="registerError"></p>
        <div class="form-group">
            <label for="register-username">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è</label>
            <input type="text" id="register-username" required>
        </div>
        <div class="form-group">
            <label for="register-password">–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å</label>
            <input type="password" id="register-password" required>
        </div>
        <button class="modal-button" onclick="handleRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        <p class="modal-switch">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="switchToLoginModal(event)">–í–æ–π—Ç–∏</a></p>
    </div>
</div>
    <script>
        const fontSizeSlider = document.getElementById('fontSize');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const indentSlider = document.getElementById('indent');
        const indentValue = document.getElementById('indentValue');
        const lineSpacingSlider = document.getElementById('lineSpacing');
        const lineSpacingValue = document.getElementById('lineSpacingValue');

        if (fontSizeSlider) {
            fontSizeSlider.addEventListener('input', () => {
                fontSizeValue.textContent = fontSizeSlider.value + ' pt';
            });
        }

        if (indentSlider) {
            indentSlider.addEventListener('input', () => {
                // toFixed(2) –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è 1.25
                indentValue.textContent = parseFloat(indentSlider.value).toFixed(2) + ' —Å–º';
            });
        }

        if (lineSpacingSlider) {
            lineSpacingSlider.addEventListener('input', () => {
                // toFixed(2) –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è 1.50
                lineSpacingValue.textContent = parseFloat(lineSpacingSlider.value).toFixed(2);
            });
        }
    let loginModal;
    let registerModal;

    async function handleCheck() {
        const form = document.getElementById('uploadForm');
        const formData = new FormData(form);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–æ–π-—Ç–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        // showLoader(); 
    
        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
    
            // –ó–¥–µ—Å—å –≤–∞—à–∞ –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏, 
            // –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
            // –í –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ –º—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (response.ok) {
                // –í–æ–∑–º–æ–∂–Ω–æ, –±—ç–∫–µ–Ω–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTML, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å
                 const htmlResult = await response.text();
                 // document.getElementById('result-container').innerHTML = htmlResult;
                 window.location.reload(); // –ü—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞.');
            }
    
        } catch (error) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ.');
        } finally {
            // hideLoader();
        }
    }
    
    
    // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
    async function handleDownload() {
        const fileInput = document.getElementById('custom-file-input');
        if (fileInput.files.length === 0) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.');
            return;
        }
    
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
    
        try {
            const response = await fetch('/download-styled', {
                method: 'POST',
                body: formData
            });
    
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –æ—Ç–≤–µ—Ç–∞
                const disposition = response.headers.get('Content-Disposition');
                let filename = 'Styled_Document.docx'; // –ò–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.');
            }
    
        } catch (error) {
            alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏.');
        }
    }

    function openLoginModal(event) {
        if (event) event.preventDefault();
        document.getElementById('loginError').textContent = '';
        if (registerModal) registerModal.style.display = 'none';
        if (loginModal) loginModal.style.display = 'block';
    }

    function closeLoginModal() {
        if (loginModal) loginModal.style.display = 'none';
    }

    function openRegisterModal(event) {
        if (event) event.preventDefault();
        document.getElementById('registerError').textContent = '';
        if (loginModal) loginModal.style.display = 'none';
        if (registerModal) registerModal.style.display = 'block';
    }

    function closeRegisterModal() {
        if (registerModal) registerModal.style.display = 'none';
    }

    function switchToRegisterModal(event) {
        openRegisterModal(event);
    }

    function switchToLoginModal(event) {
        openLoginModal(event);
    }

    async function handleLogin() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        const errorP = document.getElementById('loginError');
        
        try {
            const response = await fetch('/api/auth/signin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('jwt_token', data.token);
                window.location.reload();
            } else {
                errorP.textContent = '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å.';
            }
        } catch (error) {
            errorP.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        }
    }

    function logout(event){
        if (event) event.preventDefault();
        if (confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
            localStorage.removeItem("jwt_token");
            window.location.href = '/';
        }
    }

    async function handleRegister() {
        const username = document.getElementById('register-username').value;
        const password = document.getElementById('register-password').value;
        const errorP = document.getElementById('registerError');
        
        try {
            const response = await fetch('/api/auth/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('jwt_token', data.token);
                window.location.reload();
            } else {
                 const errorData = await response.json();
                 errorP.textContent = errorData.message || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.';
            }
        } catch (error) {
            errorP.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        }
    }

    // –í–µ—Å—å –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–¥–µ—Å—å
    document.addEventListener('DOMContentLoaded', () => {
        // 1. –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loginModal = document.getElementById('loginModal');
        registerModal = document.getElementById('registerModal');
        const loginButton = document.getElementById('loginButton');
        const userButton = document.getElementById('userButton');
        const logoutBtn = document.getElementById('logout-btn');

        // 2. –ü–ï–†–ï–ú–ï–°–¢–ò–õ–ò –õ–û–ì–ò–ö–£ –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–ù–û–ü–û–ö –°–Æ–î–ê
        if (localStorage.getItem("jwt_token")) {
            if(loginButton) loginButton.style.display = 'none';
            if(userButton) userButton.style.display = 'block';
            // if(historyList) historyList.style.display = 'block';
        } else {
            if(loginButton) loginButton.style.display = 'block';
            if(userButton) userButton.style.display = 'none';
            // if(historyList) historyList.style.display = 'none';
        }

        // 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
        // –û–Ω –±—ã–ª —É –≤–∞—Å –≤ `onclick`, –Ω–æ –ª—É—á—à–µ –µ–≥–æ –ø–æ–≤–µ—Å–∏—Ç—å –∑–¥–µ—Å—å
        if (logoutBtn) {
            logoutBtn.addEventListener('click', logout);
        }

        // 4. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
        window.onclick = function(event) {
            if (event.target == loginModal) {
                closeLoginModal();
            }
            if (event.target == registerModal) {
                closeRegisterModal();
            }
        }
    });
</script>
</body>
</html>